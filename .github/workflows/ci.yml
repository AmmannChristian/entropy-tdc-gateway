name: Entropy Gateway CI

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  checks: write
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  COVERAGE_MIN: '90'
  GOCACHE: /tmp/go-build
  GOMODCACHE: /tmp/go-mod
  GO_CACHE_VERSION: v2

jobs:
  build_and_test:
    name: Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        id: setup-go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Cache Go build and module files
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.GOCACHE }}
            ${{ env.GOMODCACHE }}
          key: go-${{ env.GO_CACHE_VERSION }}-${{ runner.os }}-${{ runner.arch }}-${{ steps.setup-go.outputs.go-version }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-${{ env.GO_CACHE_VERSION }}-${{ runner.os }}-${{ runner.arch }}-${{ steps.setup-go.outputs.go-version }}-

      - name: Install protoc
        run: |
          PROTOC_VERSION="33.5"
          wget -q "https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip"
          unzip -q protoc-${PROTOC_VERSION}-linux-x86_64.zip -d "$HOME/protoc"
          echo "$HOME/protoc/bin" >> "$GITHUB_PATH"

      - name: Download Go modules
        run: go mod download

      - name: Install developer tools
        run: make tools

      - name: Install gotestsum (JUnit output)
        run: go install gotest.tools/gotestsum@v1.13.0

      - name: Generate protobuf
        run: |
          make proto
          if git diff --quiet -- .; then
            echo "Protobuf generation is up to date"
          else
            echo "::error::Generated protobuf files are out of date. Run 'make proto' and commit changes."
            git diff -- . ':!build/**'
            exit 1
          fi

      - name: Format check
        run: |
          make fmt-fix
          git diff --stat -- . ':!pkg/pb/*.pb.go'
          if git diff --quiet -- . ':!pkg/pb/*.pb.go'; then
            echo "Code formatting is correct"
          else
            echo "::error::Code is not formatted. Run 'make fmt' locally and commit changes"
            git diff -- . ':!pkg/pb/*.pb.go'
            exit 1
          fi

      - name: Go vet
        run: make vet

      - name: Staticcheck
        run: make staticcheck

      - name: Security scan (gosec)
        run: make gosec
        continue-on-error: true

      - name: Vulnerability check (govulncheck)
        run: make govulncheck
        continue-on-error: true

      - name: Unit tests
        env:
          JUNIT_FILE: build-ci/test-junit/junit.xml
        run: |
          mkdir -p build-ci/test-junit
          make test-ci

      - name: Generate coverage report
        run: |
          mkdir -p build-ci/coverage
          set +e
          make coverage-ci
          status=$?
          cp -r build/coverage.out build-ci/coverage/ 2>/dev/null || true
          set -e
          exit $status

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: build/coverage.out

      - name: Build native binary
        run: |
          mkdir -p build-ci/binaries
          make build
          cp build/entropy-tdc-gateway build-ci/binaries/

      - name: Build ARM64 binary
        run: |
          make build-arm64
          cp build/entropy-tdc-gateway-arm64 build-ci/binaries/

      - name: List build artifacts
        run: |
          echo "::group::Build Artifacts"
          ls -lh build-ci/binaries/ 2>/dev/null || echo "No binaries found"
          echo "::endgroup::"

      - name: Check JUnit availability
        if: always()
        id: junit_check
        run: |
          if [ -f build-ci/test-junit/junit.xml ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish test report
        if: always() && steps.junit_check.outputs.available == 'true' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
        uses: dorny/test-reporter@v1
        with:
          name: Entropy Gateway Tests
          path: build-ci/test-junit/junit.xml
          reporter: java-junit
          token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-error: false

      - name: Upload coverage and test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: entropy-tdc-gateway-artifacts-${{ github.run_id }}
          path: |
            build-ci/coverage/
            build-ci/test-junit/
          retention-days: 10
          if-no-files-found: warn

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: entropy-tdc-gateway-binaries-${{ github.run_id }}
          path: build-ci/binaries/
          retention-days: 30
          if-no-files-found: error

      - name: Summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Protobuf generation:** Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Format check:** Passed" >> $GITHUB_STEP_SUMMARY
          echo "**Static analysis:** Completed" >> $GITHUB_STEP_SUMMARY
          echo "**Unit tests:** Passed" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage profile:** Generated" >> $GITHUB_STEP_SUMMARY
          echo "**Native binary:** Built" >> $GITHUB_STEP_SUMMARY
          echo "**ARM64 binary:** Built" >> $GITHUB_STEP_SUMMARY

  race_tests:
    name: Race Tests
    needs: build_and_test
    runs-on: ubuntu-latest
    continue-on-error: true
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        id: setup-go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Cache Go build and module files
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.GOCACHE }}
            ${{ env.GOMODCACHE }}
          key: go-${{ env.GO_CACHE_VERSION }}-${{ runner.os }}-${{ runner.arch }}-${{ steps.setup-go.outputs.go-version }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-${{ env.GO_CACHE_VERSION }}-${{ runner.os }}-${{ runner.arch }}-${{ steps.setup-go.outputs.go-version }}-

      - name: Install protoc
        run: |
          PROTOC_VERSION="33.5"
          wget -q "https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip"
          unzip -q protoc-${PROTOC_VERSION}-linux-x86_64.zip -d "$HOME/protoc"
          echo "$HOME/protoc/bin" >> "$GITHUB_PATH"

      - name: Download Go modules
        run: go mod download

      - name: Install developer tools
        run: make tools

      - name: Generate protobuf
        run: make proto

      - name: Run race-enabled tests
        run: make test-race
